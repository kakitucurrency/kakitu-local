# kakitu-local

This project aims to easily spin up a custom [Kakitu](https://github.com/kakitucurrency/kakitu-node) cryptocurrency network on your local computer.
Kakitu is based on [Nano](https://nano.org) but uses the address prefix "kshs_" instead of "nano_".

## Prerequisites

* Docker
* Bash shell environment
* Kakitu node binaries (nano_node and nano_rpc)
* jq (optional, for JSON formatting in testing)

## Quick Start

### Option 1: Single Node Setup (Recommended for Testing)

For a quick setup with one Kakitu node and working RPC:

```bash
# Build the Kakitu Docker image (Ubuntu 22.04 based)
./build_kakitu_ubuntu22.sh

# Start a single node
./kakitu_single_node.sh
```

This will:
- Create a Kakitu node with proper configuration
- Start both the node and RPC service
- Test RPC connectivity
- Create a wallet and account
- Expose the RPC API on port 17076

### Option 2: Multi-Node Network

For a full network with multiple interconnected nodes:

```bash
# Build the Kakitu Docker image
./build_kakitu_ubuntu22.sh

# Deploy a 4-node network
./deploy_kakitu_network.sh

# To stop the network when done
./stop_kakitu_network.sh
```

This will:
- Create 4 Kakitu nodes (1 genesis + 3 peers)
- Configure all nodes to communicate with each other
- Start both the node and RPC service on each node
- Expose RPC APIs on ports 17076-17079

## RPC Functionality

Each Kakitu node exposes an RPC API that follows the Nano RPC protocol. You can interact with it using curl:

```bash
# Check node version
curl -d '{"action": "version"}' http://127.0.0.1:17076

# Check block count
curl -d '{"action": "block_count"}' http://127.0.0.1:17076

# Create a wallet
curl -d '{"action": "wallet_create"}' http://127.0.0.1:17076

# Create an account in a wallet
curl -d '{"action": "account_create", "wallet": "WALLET_ID"}' http://127.0.0.1:17076
```

For a full list of RPC commands, see the [Nano RPC documentation](https://docs.nano.org/commands/rpc-protocol/).

## Address Format

Kakitu uses the address prefix "kshs_" instead of "nano_" but maintains backward compatibility with "xrb_" addresses. All addresses generated by the Kakitu node will have the "kshs_" prefix.

Example:
```
Private: 13EF4788603F0BF38D9F864964B269026B3367FC115D96527DC353D0A45C3D59
Public: 66192AC2D31CABE1F4132DBEA699725BD083510D5175956763FF42C27BCD5E04
Account: kshs_1sis7d3f897dw9t38dfynteq6pyiifaitndokomp9zt4rbxwtqi6br86zo6w
```

## Docker Image

Kakitu uses a custom Docker image based on Ubuntu 22.04 for GLIBC compatibility. The script `build_kakitu_ubuntu22.sh` creates this image:
```
kakitucurrency/kakitu-node:ubuntu22
```

## Advanced: Python-based Network (Optional)

For more advanced network configurations, you can use the Python-based setup:

#### Create a virtual python environment with all dependencies:

```bash
./setup_python_venv.sh
```

#### Spin up a Kakitu network:

| Action            | Code                                          | Description  |
| :----------       |:--------------------------------------------- | -----|
| create            |`$ ./nl_run.py create`      | Create folders and node config |
| start             |`$ ./nl_run.py start`       | Start all nodes and services (optional flag `--build=true` rebuilds docker containers)|
| init              |`$ ./nl_run.py init`        | Create Epochs, Canary Burn and Vote weight distribution |
| test              |`$ ./nl_run.py test`        | Runs tests from `[testcase]` section of `nl_config.toml`  |
| pytest            |`$ ./nl_run.py pytest`      | Runs tests from `[testcase]` section of `nl_config.toml` |
| stop              |`$ ./nl_run.py stop`        | Stop all nodes and services |
| stop_nodes        |`$ ./nl_run.py stop_nodes`  | Stop nodes only |
| restart           |`$ ./nl_run.py restart`     | Restart nodes only  |
| restart_wait_sync |`$ ./nl_run.py restart_wait_sync`    | Restart nodes until 100% of blocks are confirmed  |
| reset             |`$ ./nl_run.py reset`       | Delete all blocks except genesis block by removing data.ldb from all nodes |
| destroy           |`$ ./nl_run.py destroy`     | Remove all nodes and delete virtual environment |

####  Query nodes:

Each node can be queried via RPC (the Kakitu RPC protocol is compatible with [Nano's RPC protocol](https://docs.nano.org/commands/rpc-protocol/))

| Node          | RPC                        | Websocket  |
| :----------   |:-------------------------- | -----------------------|
| kl_genesis    |http://127.0.0.1:45000      | ws://127.0.0.1:47000 |
| kl_pr1        |http://127.0.0.1:45001      | ws://127.0.0.1:47001 |
| kl_pr2        |http://127.0.0.1:45002      | ws://127.0.0.1:47002 |
| kl_pr3        |http://127.0.0.1:45003      | ws://127.0.0.1:47003 |

## Troubleshooting

### Common Issues

1. **RPC Connection Errors**: Ensure IPC settings are consistent between node and RPC configuration files.
2. **GLIBC Version Errors**: Use Ubuntu 22.04 as the base Docker image (`kakitucurrency/kakitu-node:ubuntu22`).
3. **Node Not Starting**: Check container logs with `docker logs [container_name]`.
4. **Command Line Arguments**: Kakitu may not support all command line options like `--config`.

### Checking Logs

To check logs for the node and RPC service:

```bash
# View container logs
docker logs kakitu_node

# Check for RPC logs in the data directory
docker exec kakitu_node ls -la /root/log/
```

## Developer Information

### Building Kakitu from Source

If you need to build Kakitu from source, follow these steps:

1. Clone the Kakitu repository:
   ```bash
   git clone https://github.com/kakitucurrency/kakitu-node.git
   cd kakitu-node
   ```

2. Build the node and RPC executables:
   ```bash
   cmake -DCMAKE_BUILD_TYPE=Release .
   make nano_node nano_rpc
   ```

3. Copy the binaries to the kakitu-local directory:
   ```bash
   cp nano_node nano_rpc /path/to/kakitu-local/
   ```

4. Build the Docker image:
   ```bash
   cd /path/to/kakitu-local/
   ./build_kakitu_ubuntu22.sh
   ```

### Configuration Files

The key configuration files are:

1. **Node Configuration** (`config-node.toml`): Contains settings for the Kakitu node including IPC, websocket, and peering.
2. **RPC Configuration** (`config-rpc.toml`): Contains settings for the RPC service.

These files are automatically created by the scripts, but you can customize them for specific requirements.

## Resources

- [Nano Documentation](https://docs.nano.org/)
- [Kakitu GitHub Repository](https://github.com/kakitucurrency/kakitu-node)
- [Kakitu RPC Guide](KAKITU_RPC_GUIDE.md)